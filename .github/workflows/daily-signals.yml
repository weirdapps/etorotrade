name: Daily Trading Signals

on:
  schedule:
    # Run at 22:00 UTC on weekdays (after US market close at 21:00 UTC)
    # This is 00:00 Athens time (winter) or 01:00 Athens time (summer)
    # Trade takes ~4 hours, so finishes by ~02:00 UTC
    # Census runs at 00:00 UTC (~02:00-03:00 UTC actual)
    # Both complete well before morning briefing at 12:00 UTC (07:00 ET)
    - cron: '0 22 * * 1-5'
  workflow_dispatch: # Allow manual triggering

# Prevent multiple runs from overlapping
concurrency:
  group: daily-signals
  cancel-in-progress: true

jobs:
  generate-signals:
    runs-on: ubuntu-latest
    timeout-minutes: 120
    permissions:
      contents: write  # Required for git push

    steps:
      - name: Checkout repository
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python 3.11
        uses: actions/setup-python@f677139bbe7f9c59b41e40162b753c062f5d49a3 # v5.2.0
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Validate configuration
        run: python trade.py --validate-config

      - name: Download fresh portfolio from eToro
        env:
          ETORO_API_KEY: ${{ secrets.ETORO_API_KEY }}
          ETORO_USER_KEY: ${{ secrets.ETORO_USER_KEY }}
        run: |
          echo "Downloading portfolio from eToro..."
          python trade.py -o p -t n
          echo "Portfolio download complete"

      - name: Run portfolio signals (trade p)
        run: |
          echo "Running portfolio analysis..."
          python trade.py -o p
          echo "Portfolio signals complete"

      - name: Run market/eToro signals (trade e)
        run: |
          echo "Running market analysis..."
          python trade.py -o e
          echo "Market signals complete"

      - name: Generate filtered trade files (buy/sell/hold)
        run: |
          echo "Generating BUY opportunities..."
          python trade.py -o t -t b
          echo "Generating SELL opportunities..."
          python trade.py -o t -t s
          echo "Generating HOLD opportunities..."
          python trade.py -o t -t h
          echo "Trade filtering complete"

      - name: Health check - verify output files
        run: |
          echo "Verifying output files..."
          for file in portfolio.csv etoro.csv buy.csv sell.csv hold.csv; do
            filepath="yahoofinance/output/$file"
            if [ ! -f "$filepath" ]; then
              echo "ERROR: Missing output file: $filepath"
              exit 1
            fi
            rows=$(wc -l < "$filepath")
            echo "  $file: $rows lines"
            if [ "$rows" -lt 2 ]; then
              echo "ERROR: $filepath has fewer than 2 lines (header + data)"
              exit 1
            fi
          done
          echo "All output files verified"

      - name: Configure Git
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "GitHub Actions Bot"

      - name: Commit portfolio and signal outputs
        run: |
          # Add input portfolio (refreshed from eToro)
          git add yahoofinance/input/portfolio.csv || true

          # Add output files
          git add yahoofinance/output/*.csv || true

          # Only commit if there are changes
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            COMMIT_DATE=$(date -u +'%Y-%m-%d %H:%M UTC')
            git commit -m "Daily signals - $COMMIT_DATE

          - Portfolio refreshed from eToro
          - Signals regenerated

          Auto-generated by daily-signals workflow"

            # Push with retry
            for i in 1 2 3; do
              echo "Push attempt $i..."
              git pull --rebase origin master && git push && break
              echo "Attempt $i failed, retrying in 5 seconds..."
              sleep 5
            done
            echo "Portfolio and signals committed and pushed"
          fi

      - name: Upload portfolio and signal outputs as artifacts
        uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882 # v4.4.3
        with:
          name: signals-${{ github.run_id }}
          path: |
            yahoofinance/input/portfolio.csv
            yahoofinance/output/portfolio.csv
            yahoofinance/output/etoro.csv
            yahoofinance/output/buy.csv
            yahoofinance/output/sell.csv
            yahoofinance/output/hold.csv
          retention-days: 30

  # Failure notification
  notify-failure:
    runs-on: ubuntu-latest
    needs: generate-signals
    if: failure()
    permissions:
      issues: write  # Required for creating failure issues
    steps:
      - name: Create failure issue
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            const date = new Date().toISOString().split('T')[0];

            // Check for existing open issues
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'signals-failure,automated'
            });

            const existingIssue = issues.find(issue =>
              issue.title.includes('Daily Signals Failed')
            );

            if (existingIssue) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: `## Another failure occurred\n\n**Date**: ${date}\n**Run**: ${runUrl}`
              });
            } else {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `Daily Signals Failed - ${date}`,
                body: `## Daily Trading Signals Generation Failed\n\n**Date**: ${date}\n**Workflow Run**: ${runUrl}\n\n### Common Issues\n- Yahoo Finance API rate limiting\n- Network timeouts\n- Configuration validation failure\n\n---\n*Auto-created by signals failure alerting*`,
                labels: ['signals-failure', 'automated', 'bug']
              });
            }
