name: Daily Trading Signals

on:
  schedule:
    # Run at 22:00 UTC on weekdays (after US market close at 21:00 UTC)
    # This is 00:00 Athens time (winter) or 01:00 Athens time (summer)
    # Trade e takes ~4 hours, so finishes by ~02:00 UTC
    # Census runs at 00:00 UTC (~02:00-03:00 UTC actual)
    # Both complete well before morning briefing at 12:00 UTC (07:00 ET)
    - cron: '0 22 * * 1-5'
  workflow_dispatch: # Allow manual triggering

# Prevent multiple runs from overlapping
concurrency:
  group: daily-signals
  cancel-in-progress: true

jobs:
  generate-signals:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Required for git push

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Validate configuration
        run: python trade.py --validate-config

      - name: Download fresh portfolio from eToro
        env:
          ETORO_API_KEY: ${{ secrets.ETORO_API_KEY }}
          ETORO_USER_KEY: ${{ secrets.ETORO_USER_KEY }}
        run: |
          echo "üì• Downloading portfolio from eToro..."
          python trade.py -o p -t n
          echo "‚úÖ Portfolio download complete"

      - name: Run portfolio signals (trade p)
        run: |
          echo "üîç Running portfolio analysis..."
          python trade.py -o p
          echo "‚úÖ Portfolio signals complete"

      - name: Run market/eToro signals (trade e)
        run: |
          echo "üîç Running market analysis..."
          python trade.py -o e
          echo "‚úÖ Market signals complete"

      - name: Configure Git
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "GitHub Actions Bot"

      - name: Commit portfolio and signal outputs
        run: |
          # Add input portfolio (refreshed from eToro)
          git add yahoofinance/input/portfolio.csv || true

          # Add output files
          git add yahoofinance/output/*.csv || true

          # Only commit if there are changes
          if git diff --staged --quiet; then
            echo "‚ö†Ô∏è  No changes to commit"
          else
            COMMIT_DATE=$(date -u +'%Y-%m-%d %H:%M UTC')
            git commit -m "Daily signals - $COMMIT_DATE

          - Portfolio refreshed from eToro
          - Signals regenerated

          Auto-generated by daily-signals workflow"

            # Push with retry
            for i in 1 2 3; do
              echo "Push attempt $i..."
              git pull --rebase origin master && git push && break
              echo "Attempt $i failed, retrying in 5 seconds..."
              sleep 5
            done
            echo "‚úÖ Portfolio and signals committed and pushed"
          fi

      - name: Upload portfolio and signal outputs as artifacts
        uses: actions/upload-artifact@v4
        with:
          name: signals-${{ github.run_id }}
          path: |
            yahoofinance/input/portfolio.csv
            yahoofinance/output/portfolio.csv
            yahoofinance/output/market.csv
            yahoofinance/output/buy.csv
            yahoofinance/output/sell.csv
          retention-days: 30

  # Failure notification
  notify-failure:
    runs-on: ubuntu-latest
    needs: generate-signals
    if: failure()
    permissions:
      issues: write  # Required for creating failure issues
    steps:
      - name: Create failure issue
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            const date = new Date().toISOString().split('T')[0];

            // Check for existing open issues
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'signals-failure,automated'
            });

            const existingIssue = issues.find(issue =>
              issue.title.includes('Daily Signals Failed')
            );

            if (existingIssue) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: `## ‚ö†Ô∏è Another failure occurred\n\n**Date**: ${date}\n**Run**: ${runUrl}`
              });
            } else {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `üö® Daily Signals Failed - ${date}`,
                body: `## Daily Trading Signals Generation Failed\n\n**Date**: ${date}\n**Workflow Run**: ${runUrl}\n\n### Common Issues\n- Yahoo Finance API rate limiting\n- Network timeouts\n- Configuration validation failure\n\n---\n*Auto-created by signals failure alerting*`,
                labels: ['signals-failure', 'automated', 'bug']
              });
            }
